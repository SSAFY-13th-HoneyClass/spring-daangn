# 5ì£¼ì°¨ ë¯¸ì…˜

## 1ï¸âƒ£Â JWT ì¸ì¦(Authentication) ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê¸°

### ğŸ”¹ ê°œë…
**JWT (JSON Web Token)**ì€ **ì‚¬ìš©ìì˜ ì¸ì¦ ì •ë³´ë‚˜ ê¶Œí•œ ì •ë³´**ë¥¼ í¬í•¨í•´ì„œ ì„œëª…ì„ í•œ í›„ í† í° í˜•íƒœë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.  
ë‹¤ì‹œ ë§í•´ ì„¸ì…˜ì´ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ ì—†ì´ ì´ í† í° í•˜ë‚˜ë§Œ í™•ì¸í•´ì„œ "ëˆ„êµ¬ì¸ê°€?" "ë¬´ìŠ¨ ê¶Œí•œì¸ê°€?" ë¥¼ íŒë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ğŸ”¹ ë™ì‘ ë°©ì‹
1ï¸âƒ£ **ë¡œê·¸ì¸ì‹œ**, í´ë¼ì´ì–¸íŠ¸ë¥¼ í†µí•´ **ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸** ì „ë‹¬  
2ï¸âƒ£ **ì„œë²„ëŠ” ê²€ì¦ í›„ JWT ìƒì„±** (Header, Payload, Signature í¬í•¨)  
   - Payloadì— `sub(ì‚¬ìš©ì ì‹ë³„ê°’)`ì´ë‚˜ `exp(ë§Œë£Œ)` ì •ë³´ í¬í•¨

3ï¸âƒ£ ì´ í† í°(**Access Token**)ì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬  
4ï¸âƒ£ í›„ì— í´ë¼ì´ì–¸íŠ¸ë¥¼ í¬í•¨í•œ ë§¤ ìš”ì²­ì‹œ  
```http
Authorization:Bearer {TOKEN}
```
í˜•íƒœì˜ Headerë¡œ ì „ë‹¬

5ï¸âƒ£ APIì„œë²„ëŠ” í•´ë‹¹ í† í°ì˜ ì„œëª…ì„ í™•ì¸í•¨ìœ¼ë¡œì¨ ì„¸ì…˜ì´ë‚˜ DB ì¡°íšŒì—†ì´ ê¶Œí•œ í™•ì¸ ê°€ëŠ¥

### ğŸ”¹ ì•¡ì„¸ìŠ¤ í† í°, ë¦¬í”„ë ˆì‹œ í† í°
ì•¡ì„¸ìŠ¤ í† í° (Access Token)

ë§Œë£Œ ê¸°ê°„ì´ ì§§ì•„ (ì˜ˆ: 15ë¶„ ~ 1ì‹œê°„)

API ìš”ì²­ì‹œ ë§¤ë²ˆ í¬í•¨ë˜ì–´ ê¶Œí•œ í™•ì¸ ìˆ˜í–‰

ë¦¬í”„ë ˆì‹œ í† í° (Refresh Token)

ë§Œë£Œ ê¸°ê°„ì´ ê¸¸ê³  (ì˜ˆ: 1ì£¼, í•œë‹¬)

ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œì‹œ ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ìƒˆë¡œìš´ ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰

ì´ë¡œ ì¸í•´ ì„¸ì…˜ì´ë‚˜ DB í™•ì¸ì—†ì´ ë¬´ìƒí•˜ê²Œ ì„¸ì…˜ ë§Œë£Œë‚˜ ë¬´íš¨ í† í° ê´€ë¦¬ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì„¸ì…˜, ì¿ í‚¤, OAuth ê°™ì€ ë‹¤ë¥¸ ë°©ì‹
### ğŸ”¹ ì„¸ì…˜ (Server-side ì„¸ì…˜)
ì„¸ì…˜ ID ë§Œ í´ë¼ì´ì–¸íŠ¸ë¥¼ í†µí•´ ì „ë‹¬ (ë³´í†µ ì„¸ì…˜ ì €ì¥ì†Œë‚˜ DBì— ì •ë³´ ì €ì¥)

ì„¸ì…˜ ë§Œë£Œë‚˜ ë¬´íš¨ ì²˜ë¦¬ì‹œ í•´ë‹¹ ì„¸ì…˜ë§Œ ë§Œë£Œ ê°€ëŠ¥

ìƒíƒœ ì •ë³´ê°€ ì„œë²„ì— ì €ì¥ëœë‹¤ â†’ "Stateful"

### ğŸ”¹ ì¿ í‚¤ (Cookies)
ì„¸ì…˜ì´ë‚˜ JWT í† í°ì´ë‚˜ CSRF í† í° ë“±ì„ í´ë¼ì´ì–¸íŠ¸ë¥¼ í†µí•´ ì €ì¥ì‹œí‚¤ëŠ” ë° í™œìš©

ë§Œë£Œë‚˜ ë„ë©”ì¸ì„ í¬í•¨í•  ìˆ˜ ìˆìœ¼ë©° HttpOnly, Secure ì˜µì…˜ìœ¼ë¡œ ë³´ì•ˆì„ ê°•í™”í•  ìˆ˜ ìˆìŒ

### ğŸ”¹ OAuth
"ì¹´ì¹´ì˜¤, ë„¤ì´ë²„, êµ¬ê¸€" ê°™ì€ ì œ3ì˜ ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê²Œ í•¨

ë³„ë„ì˜ íšŒì› ê°€ì…ì´ë‚˜ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì ˆì°¨ê°€ í•„ìš”ì—†ê³  í•´ë‹¹ ì„œë¹„ìŠ¤ì˜ ê¶Œí•œ í™•ì¸ê³¼ APIë¥¼ í™œìš©í•  ìˆ˜ ìˆìŒ

Access Tokenì´ë‚˜ Refresh Tokenì˜ ê°œë…ê³¼ ìœ ì‚¬í•˜ê²Œ ë™ì‘

## 2ï¸âƒ£Â ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ë° ê²€ì¦ ë¡œì§ êµ¬í˜„í•˜ê¸°
```java
public String createJwt(String username, String role, Long expiredMs) {

        return Jwts.builder()
                .claim("username", username)
                .claim("role", role)
                .issuedAt(new Date(System.currentTimeMillis()))
                .expiration(new Date(System.currentTimeMillis() + expiredMs))
                .signWith(secretKey)
                .compact();
    }
```

```java
@Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {

        //requestì—ì„œ Authorization í—¤ë”ë¥¼ ì°¾ìŒ
        String authorization= request.getHeader("Authorization");

        //Authorization í—¤ë” ê²€ì¦
        if (authorization == null || !authorization.startsWith("Bearer ")) {

            System.out.println("token null");
            filterChain.doFilter(request, response);

            //ì¡°ê±´ì´ í•´ë‹¹ë˜ë©´ ë©”ì†Œë“œ ì¢…ë£Œ (í•„ìˆ˜)
            return;
        }

        String token = authorization.split(" ")[1];

        //í† í° ì†Œë©¸ ì‹œê°„ ê²€ì¦
        if (jwtUtil.isExpired(token)) {

            System.out.println("token expired");
            filterChain.doFilter(request, response);

            //ì¡°ê±´ì´ í•´ë‹¹ë˜ë©´ ë©”ì†Œë“œ ì¢…ë£Œ (í•„ìˆ˜)
            return;
        }


        String username = jwtUtil.getUsername(token);
        String role = jwtUtil.getRole(token);

        UserEntity userEntity = new UserEntity();
        userEntity.setUsername(username);
        userEntity.setPassword("temppassword");
        userEntity.setRole(role);

        CustomUserDetails customUserDetails = new CustomUserDetails(userEntity);

        Authentication authToken = new UsernamePasswordAuthenticationToken(customUserDetails, null, customUserDetails.getAuthorities());

        SecurityContextHolder.getContext().setAuthentication(authToken);

        filterChain.doFilter(request, response);
    }
```
## 3ï¸âƒ£ íšŒì›ê°€ì… ë° ë¡œê·¸ì¸ API êµ¬í˜„
- íšŒì›ê°€ì…
```java
@PostMapping("/join")
    public ResponseEntity<Objects> join(@RequestBody JoinDTO joinDTO) {
        userService.joinProcess(joinDTO);
        return ResponseEntity.ok().build();
    }
```
- ë¡œê·¸ì¸
```java
public class LoginFilter extends UsernamePasswordAuthenticationFilter {

    private final AuthenticationManager authenticationManager;
    private final JWTUtil jwtUtil;

    public LoginFilter(AuthenticationManager authenticationManager, JWTUtil jwtUtil) {

        this.authenticationManager = authenticationManager;
        this.jwtUtil = jwtUtil;
    }

    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {

        String username = obtainUsername(request);
        String password = obtainPassword(request);

        System.out.println(username);

        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(username, password, null);

        return authenticationManager.authenticate(authToken);
    }

    @Override
    protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authentication) {

        CustomUserDetails customUserDetails = (CustomUserDetails) authentication.getPrincipal();

        String username = customUserDetails.getUsername();

        Collection<? extends GrantedAuthority> authorities = authentication.getAuthorities();
        Iterator<? extends GrantedAuthority> iterator = authorities.iterator();
        GrantedAuthority auth = iterator.next();

        String role = auth.getAuthority();


        String token = jwtUtil.createJwt(username, role, 60*60*10L);

        response.addHeader("Authorization", "Bearer " + token);
    }

    @Override
    protected void unsuccessfulAuthentication(HttpServletRequest request, HttpServletResponse response, AuthenticationException failed) {

        response.setStatus(401);
    }
}
```
## 4ï¸âƒ£ í† í°ì´ í•„ìš”í•œ API
```java
@GetMapping
    public ResponseEntity<UserResponse> get(@AuthenticationPrincipal CustomUserDetails customUserDetails) {
        String username = customUserDetails.getUsername();
        UserEntity user = userService.getByUsername(username);
        return ResponseEntity.ok(UserResponse.from(user));
    }
```

## 
