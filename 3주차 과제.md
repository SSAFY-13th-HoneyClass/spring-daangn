# ğŸ” JPA N+1

## âœ… N+1 ë¬¸ì œë€?

JPAì—ì„œ **ì—°ê´€ ê´€ê³„ê°€ ì„¤ì •ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒ**í•  ë•Œ ë°œìƒí•˜ëŠ” ì„±ëŠ¥ ë¬¸ì œì…ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, `ProductEntity`ê°€ `UserEntity`ë¥¼ `@ManyToOne`ìœ¼ë¡œ ì°¸ì¡°í•˜ëŠ” ìƒí™©ì—ì„œ `ProductEntity` ë¦¬ìŠ¤íŠ¸ë¥¼ ì¡°íšŒí•˜ê³ , ê° `ProductEntity`ì˜ `writer`(ì‘ì„±ì)ë¥¼ ì¡°íšŒí•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì¿¼ë¦¬ê°€ ë°œìƒí•©ë‹ˆë‹¤:

### âŒ ë¬¸ì œ ë°œìƒ ì˜ˆì‹œ

```java
List<ProductEntity> products = productRepository.findAll();

for (ProductEntity p : products) {
    System.out.println(p.getWriter().getEmail()); // writerëŠ” LAZY ë¡œë”©ì´ë¼ ë§¤ë²ˆ ì¿¼ë¦¬ ë°œìƒ
}
```

ë°œìƒ ì¿¼ë¦¬ (N+1 ë¬¸ì œ)
select * from products â€” 1ë²ˆ

select * from users where id = ? â€” ìƒí’ˆ ìˆ˜ë§Œí¼ ë°˜ë³µ (Në²ˆ)

â†’ ì´ 1 + N ì¿¼ë¦¬ ë°œìƒ â†’ ì„±ëŠ¥ ì €í•˜

ğŸ§ª í…ŒìŠ¤íŠ¸ ì½”ë“œ
```java
    @Test
    void íŒë§¤ë¬¼í’ˆ_ì „ì²´ëª©ë¡ì˜_ì‘ì„±ì_ì¡°íšŒí•˜ê¸°(){
        //given
        UserEntity user1 = new UserEntity();
        user1.setEmail("abcd1@gmail.com");
        user1.setPhoneNumber("010-1234-5678");
        user1.setMannerTemperature(36.7);
        userRepository.save(user1);

        UserEntity user2 = new UserEntity();
        user2.setEmail("abcd2@gmail.com");
        user2.setPhoneNumber("010-1234-5678");
        user2.setMannerTemperature(36.8);
        userRepository.save(user2);

        UserEntity user3 = new UserEntity();
        user3.setEmail("abcd3@gmail.com");
        user3.setPhoneNumber("010-1234-5678");
        user3.setMannerTemperature(36.9);
        userRepository.save(user3);

        ProductEntity product1 = new ProductEntity();
        product1.setWriter(user1);
        product1.setTitle("ì œëª©1");
        product1.setDescription("ë‚´ìš©1");
        product1.setPrice(10000);
        product1.setStatus("on_sale");
        productService.create(product1);

        ProductEntity product2 = new ProductEntity();
        product2.setWriter(user2);
        product2.setTitle("ì œëª©2");
        product2.setDescription("ë‚´ìš©2");
        product2.setPrice(10000);
        product2.setStatus("on_sale");
        productService.create(product2);

        ProductEntity product3 = new ProductEntity();
        product3.setWriter(user3);
        product3.setTitle("ì œëª©3");
        product3.setDescription("ë‚´ìš©3");
        product3.setPrice(10000);
        product3.setStatus("on_sale");
        productService.create(product3);

        em.flush();
        em.clear();

        //when
        List<ProductEntity> products = productService.getAll();

        //then
        System.out.println("==============start===============");
        for (ProductEntity product: products) {
            System.out.println(product.getWriter().getEmail());
        }
        System.out.println("==============end===============");
    }
```
âœ… @EntityGraph ì ìš© ì „ ì‹¤í–‰ ê²°ê³¼ ì¿¼ë¦¬

<img width="641" alt="image" src="https://github.com/user-attachments/assets/18d0159c-40c4-4688-9144-8a7583976be2" />

productsë¥¼ ë¶ˆëŸ¬ì˜¨ ì´í›„ ë“¤ì–´ìˆëŠ” UserEntityë¥¼ ì¡°íšŒí•˜ë©´ì„œ 3ê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ì—¬ ì´ 4ê°œì˜ select ì¿¼ë¦¬ê°€ ë°œìƒí•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

âœ… @EntityGraph ì ìš© í›„ ì‹¤í–‰ ê²°ê³¼ ì¿¼ë¦¬

<img width="526" alt="image" src="https://github.com/user-attachments/assets/82c84049-fbd7-4f3e-8a53-911a180c7ae5" />

productsë¥¼ ë¶ˆëŸ¬ì˜¨ ì´í›„ ë“¤ì–´ìˆëŠ” UserEnttityë¥¼ ì¡°íšŒí•  ë•Œ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì´ 1ê°œì˜ select ì¿¼ë¦¬ê°€ ë°œìƒí•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

# âš ï¸ JPA N+1 ë¬¸ì œì™€ ë°œìƒí•˜ì§€ ì•Šì•˜ë˜ ì´ìœ , ê·¸ë¦¬ê³  í•´ê²° ë°©ë²•

âœ… ì›ì¸ ìš”ì•½

@ManyToOne(fetch = FetchType.LAZY)ë¡œ ì„¤ì •ëœ ì—°ê´€ ê°ì²´(UserEntity)ëŠ” í”„ë¡ì‹œ ê°ì²´ë¡œ ë¶ˆëŸ¬ì™€ì§‘ë‹ˆë‹¤.

í”„ë¡ì‹œëŠ” ì‹¤ì œ DB ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ëŠ” ì‹œì ê¹Œì§€ ìœ ì˜ˆë˜ëŠ”ë°,

ì´ ë•Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì´ë¯¸ ë‹«í˜€ ìˆë‹¤ë©´ â†’ ë” ì´ìƒ DB ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•´ì„œ ìœ„ì™€ ê°™ì€ ì˜ˆì™¸ ë°œìƒ.

âœ… ì™œ @Transactional ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë‚˜ëŠ”ê°€?

í…ŒìŠ¤íŠ¸ ë©”ì„œë“œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ë°”ê¹¥ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.

Spring Data JPAëŠ” ì§€ì—° ë¡œë”©ì„ ìœ„í•´ íŠ¸ëœì­ì…˜ ë²”ìœ„ ë‚´ì—ì„œ Hibernate Sessionì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

@Transactionalì´ ì—†ìœ¼ë©´ ì¡°íšŒëœ ê°ì²´ëŠ” detached ìƒíƒœê°€ ë˜ì–´, ì§€ì—° ë¡œë”©ì„ ì‹œë„í•˜ë©´ sessionì´ ì—†ë‹¤ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

âœ… í•´ê²° ë°©ë²•

âœ… 1. @Transactional ë¶™ì´ê¸° â† ì¼ë°˜ì ì¸ í•´ê²°ì±…

ì´ ê²½ìš°, LAZYë¡œë”©ë„ ì •ìƒ ì‘ë™í•˜ê³  ì˜¤ë¥˜ ì—†ìŒ
í•˜ì§€ë§Œ N+1 ë¬¸ì œëŠ” ê°ì¶°ì§€ë¯€ë¡œ í™•ì¸ ë¶ˆê°€

âœ… 2. ê°•ì œë¡œ N+1 ë¬¸ì œ í™•ì¸í•˜ë ¤ë©´?
@Transactional ìœ ì§€í•œ ì±„ flush + clear ì‚¬ìš©

```java
@Test
@Transactional
void íŒë§¤ë¬¼í’ˆ_ì „ì²´ëª©ë¡ì˜_ì‘ì„±ì_ì¡°íšŒí•˜ê¸°(){
    //given
    ...
    userRepository.save(user1);
    userRepository.save(user2);
    userRepository.save(user3);

    productService.create(product1);
    productService.create(product2);
    productService.create(product3);

    em.flush();
    em.clear(); // â˜… ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” â˜…

    //when
    List<ProductEntity> products = productService.getAll(); // ì´ë•Œ LAZY proxyë§Œ ìˆìŒ

    //then
    for (ProductEntity product: products) {
        System.out.println(product.getWriter().getEmail()); // ì—¬ê¸°ì„œ N+1 ë°œìƒ
    }
}
```
ì´ ë°©ì‹ì´ë©´ @Transactionalë¡œ ì„¸ì…˜ì€ ì‚´ì•„ìˆì§€ë§Œ, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ì´ˆê¸°í™”ë˜ë¯€ë¡œ ì‹¤ì œ N+1 ì¿¼ë¦¬ ë°œìƒ ì—¬ë¶€ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”.
